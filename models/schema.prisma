// Prisma schema for Homesy
// Run: npx prisma generate && npx prisma migrate dev

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String
  email         String    @unique
  passwordHash  String
  isAdmin       Boolean   @default(false)
  subscription  Subscription?
  creditAccount CreditAccount?
  orders        Order[]
}

model Subscription {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id])
  userId       Int      @unique
  status       SubscriptionStatus @default(ACTIVE)
  price        Int      // ₹ per month
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

model CreditAccount {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int      @unique
  limit      Int      @default(5000) // ₹
  used       Int      @default(0)    // ₹ used in current month
  resetDay   Int      @default(1)    // Day of month when usage resets
  updatedAt  DateTime @updatedAt
}

model Product {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  description String?
  price     Int      // ₹
  discount  Int      @default(0) // percent
  stock     Int      @default(0)
  imageUrl  String?
  orderItems OrderItem[]
}

model Order {
  id         Int        @id @default(autoincrement())
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  user       User       @relation(fields: [userId], references: [id])
  userId     Int
  status     OrderStatus @default(PENDING)
  total      Int        // ₹ total after discounts
  items      OrderItem[]
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELED
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  order     Order   @relation(fields: [orderId], references: [id])
  orderId   Int
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  quantity  Int
  unitPrice Int   // price per unit at purchase time (after discount)
}
